<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ã¶ã£è±šã€€ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆğŸ–</title>
<style>
    :root {
        --c-hall: #007bff;
        --c-kit: #dc3545;
        --c-wash: #28a745;
        --bg: #f4f7f6;
    }
    body { font-family: sans-serif; margin: 0; padding: 0; background: var(--bg); padding-bottom: 70px; }
    
    /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
    header { background: white; padding: 15px; text-align: center; border-bottom: 1px solid #ddd; position: sticky; top: 0; z-index: 10; }
    h1 { margin: 0; font-size: 1.2rem; }
    #last-update { font-size: 0.7rem; color: #666; margin-top: 5px; }

    /* ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ */
    #login-view { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 100; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    .login-inner { width: 80%; max-width: 400px; text-align: center; }
    input[type="text"] { width: 100%; padding: 12px; font-size: 1rem; margin-bottom: 20px; box-sizing: border-box; }
    .role-btn { width: 100%; padding: 15px; margin-bottom: 10px; border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; font-size: 1rem; }

    /* ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆç”»é¢ */
    .list-section { background: white; margin: 15px; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .role-header { padding: 10px 15px; color: white; font-weight: bold; display: flex; justify-content: space-between; }
    .worker-name { font-size: 0.8rem; background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 10px; }
    
    .check-item { padding: 12px 15px; border-bottom: 1px solid #eee; display: flex; align-items: center; }
    input[type="checkbox"] { transform: scale(1.5); margin-right: 15px; }

    /* è‡ªåˆ†ã®æ‹…å½“ä»¥å¤– */
    .disabled-area { opacity: 0.6; background: #fafafa; pointer-events: none; }
    /* è‡ªåˆ†ã®æ‹…å½“ */
    .active-area { border: 2px solid #333; transform: scale(1.02); transition: 0.2s; }

    /* æ›´æ–°ãƒœã‚¿ãƒ³ */
    .sync-area { padding: 0 15px; }
    .sync-btn { width: 100%; padding: 15px; background: #333; color: white; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: bold; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
    .sync-btn:active { transform: scale(0.98); }

    /* å±¥æ­´ç”»é¢ */
    #history-view { display: none; padding: 15px; }
    .history-card { background: white; padding: 10px; border-radius: 8px; margin-bottom: 8px; border-left: 5px solid #ccc; font-size: 0.9rem; }

    /* ä¸‹éƒ¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
    .nav-bar { position: fixed; bottom: 0; left: 0; width: 100%; height: 60px; background: white; border-top: 1px solid #ddd; display: flex; z-index: 50; }
    .nav-item { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #999; font-size: 0.7rem; cursor: pointer; }
    .nav-item.active { color: #e44d26; font-weight: bold; }
    .nav-icon { font-size: 1.5rem; margin-bottom: 2px; }

</style>
</head>
<body>

    <header>
        <h1>ğŸœ é–‰åº—æ¥­å‹™</h1>
        <div id="last-update">æœªæ›´æ–°</div>
    </header>

    <div id="login-view">
        <div class="login-inner">
            <h2>æ¥­å‹™é–‹å§‹</h2>
            <p>åå‰ã‚’å…¥åŠ›</p>
            <input type="text" id="input-name" placeholder="ä¾‹ï¼šæ‘ä¸Š">
            <p>æ‹…å½“ã‚’é¸æŠ</p>
            <button class="role-btn" style="background:var(--c-kit)" onclick="login('kitchen')">ğŸ”¥ 1ç•ªæ‰‹</button>
            <button class="role-btn" style="background:var(--c-hall)" onclick="login('hall')">ğŸ–ï¸ ãƒ›ãƒ¼ãƒ«</button>
            <button class="role-btn" style="background:var(--c-wash)" onclick="login('wash')">ğŸ§¼ æ´—ã„å ´</button>
        </div>
    </div>

    <div id="main-view">
        
        <div id="area-kitchen" class="list-section">
            <div class="role-header" style="background:var(--c-kit)">
                <span>ğŸ”¥ 1ç•ªæ‰‹</span> <span class="worker-name" id="user-kitchen">-</span>
            </div>
            <div id="list-kitchen"></div>
        </div>

        <div id="area-hall" class="list-section">
            <div class="role-header" style="background:var(--c-hall)">
                <span>ğŸ–ï¸ ãƒ›ãƒ¼ãƒ«</span> <span class="worker-name" id="user-hall">-</span>
            </div>
            <div id="list-hall"></div>
        </div>

        <div id="area-wash" class="list-section">
            <div class="role-header" style="background:var(--c-wash)">
                <span>ğŸ§¼ æ´—ã„å ´</span> <span class="worker-name" id="user-wash">-</span>
            </div>
            <div id="list-wash"></div>
        </div>

        <div class="sync-area">
            <button class="sync-btn" onclick="syncData()">ğŸ”„ æ›´æ–°ï¼†å…±æœ‰ã™ã‚‹</button>
            <p style="text-align:center; font-size:0.8rem; color:#666;">â€»ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ä»–äººã®çŠ¶æ³ã‚‚è¦‹ã‚Œã¾ã™</p>
        </div>
    </div>

    <div id="history-view">
        <h3 style="text-align:center">éå»ã®å®Œäº†å±¥æ­´</h3>
        <button onclick="loadHistory()" style="width:100%; padding:10px; margin-bottom:10px;">å†èª­ã¿è¾¼ã¿</button>
        <div id="history-list">èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>

    <div class="nav-bar">
        <div class="nav-item active" onclick="switchTab('main')">
            <span class="nav-icon">ğŸ“</span>ãƒã‚§ãƒƒã‚¯
        </div>
        <div class="nav-item" onclick="switchTab('history')">
            <span class="nav-icon">ğŸ“…</span>å±¥æ­´
        </div>
    </div>

<script>
    // â˜…æ–°ã—ã„GASã®URLã‚’å…¥ã‚Œã‚‹â˜…
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyBepEsyAN2WdAMIkAlhtfiTul9EPKOEdJVZQEHapAOdubmmdoDpCvMjRI_YlV_bus8/exec";

    // ãƒ‡ãƒ¼ã‚¿å®šç¾©
    const ROLES = {
        kitchen: ["ã‚¬ã‚¹ã®å…ƒæ “é–‰", "ã‚³ãƒ¼ãƒ«ãƒ‰ãƒ†ãƒ¼ãƒ–ãƒ«", "ã‚¹ãƒ¼ãƒ—ãƒ»è‚‰ãƒ»é‡èœåç´", "è£œå……ç³»å®Œäº†", "æ°´é“é–‰", "éººæ®‹é‡è¨˜å…¥"],
        hall: ["ç®¸é†¤æ²¹ã€ãƒãƒ¨è£œå……", "ç”Ÿå§œé–‰ã¾ã£ãŸã‹", "åºŠã‚´ãƒŸç¢ºèª", "åˆ¸å£²æ©Ÿãƒ»éµé–‰ã‚", "èƒŒè„‚SWã‚ªãƒ•", "åµè£œå……", "ã‚´ãƒŸãƒ»ãƒˆã‚¤ãƒ¬é›»æ°—", "ã‚³ãƒƒãƒ—ã®ç‰‡ã¥ã‘", "ãƒ†ãƒ¼ãƒ–ãƒ«å…¨æ‹­ã"],
        wash: ["æ´—å‰¤ãƒ»ãƒãƒ³ãƒ‰ã‚½ãƒ¼ãƒ—è£œå……", "ã‚´ãƒŸæ¨ã¦å®Œäº†", "ã‚·ãƒ³ã‚¯å†…æ¸…æƒ", "æ´—ã„å ´ã‚´ãƒŸç¢ºèª"]
    };

    let myRole = "";
    let myName = "";
    
    // å…¨å“¡ã®çŠ¶æ…‹ï¼ˆåˆæœŸå€¤ï¼‰
    let globalState = {
        kitchen: { checks: [], user: "" },
        hall: { checks: [], user: "" },
        wash: { checks: [], user: "" }
    };

    // èµ·å‹•æ™‚ã®å‡¦ç†ï¼ˆç¿Œæœã‚¯ãƒªã‚¢ï¼‰
    window.onload = function() {
        const today = new Date().toLocaleDateString('ja-JP');
        const savedDate = localStorage.getItem('ramen_date');

        if (savedDate !== today) {
            localStorage.removeItem('ramen_state'); // å¤ã„ãƒ‡ãƒ¼ã‚¿å‰Šé™¤
            localStorage.setItem('ramen_date', today);
        } else {
            const saved = localStorage.getItem('ramen_state');
            if(saved) globalState = JSON.parse(saved);
        }

        const savedName = localStorage.getItem('ramen_name');
        if(savedName) document.getElementById('input-name').value = savedName;
    };

    function login(role) {
        const name = document.getElementById('input-name').value;
        if(!name) return alert("åå‰ã‚’å…¥ã‚Œã¦ãã ã•ã„");
        
        myRole = role;
        myName = name;
        localStorage.setItem('ramen_name', myName);

        document.getElementById('login-view').style.display = 'none';
        
        initView(); // ç”»é¢æ§‹ç¯‰
        syncData(); // æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã«ã„ã
    }

    // ç”»é¢æ§‹ç¯‰ï¼ˆè‡ªåˆ†ã®æ‹…å½“ã¯ç™½ã€ä»–äººã¯ã‚°ãƒ¬ãƒ¼ï¼‰
    function initView() {
        ['kitchen', 'hall', 'wash'].forEach(role => {
            const container = document.getElementById(`list-${role}`);
            const area = document.getElementById(`area-${role}`);
            
            container.innerHTML = "";
            
            // ã‚¹ã‚¿ã‚¤ãƒ«é©ç”¨
            if(role === myRole) {
                area.classList.remove('disabled-area');
                area.classList.add('active-area');
            } else {
                area.classList.add('disabled-area');
                area.classList.remove('active-area');
            }

            // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ç”Ÿæˆ
            ROLES[role].forEach((text, idx) => {
                const isChecked = !!globalState[role].checks[idx];
                container.innerHTML += `
                    <div class="check-item">
                        <input type="checkbox" id="chk-${role}-${idx}" ${isChecked ? "checked" : ""} onchange="localCheck('${role}', ${idx})">
                        <span>${text}</span>
                    </div>
                `;
            });
            
            // åå‰ã‚»ãƒƒãƒˆ
            document.getElementById(`user-${role}`).innerText = globalState[role].user || "-";
        });
    }

    // ãƒã‚§ãƒƒã‚¯ã—ãŸç¬é–“ã«ã‚¹ãƒãƒ›å†…ã«ä¸€æ™‚ä¿å­˜
    function localCheck(role, idx) {
        const chk = document.getElementById(`chk-${role}-${idx}`);
        if(!globalState[role].checks) globalState[role].checks = [];
        globalState[role].checks[idx] = chk.checked;
        globalState[role].user = myName;
        
        localStorage.setItem('ramen_state', JSON.stringify(globalState));
    }

    // æ›´æ–°å‡¦ç†ï¼ˆé€ä¿¡ï¼†å—ä¿¡ï¼‰
    async function syncData() {
        const btn = document.querySelector('.sync-btn');
        btn.innerText = "é€šä¿¡ä¸­...";
        btn.disabled = true;

        try {
            // è‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡
            const payload = {
                action: "update",
                data: {
                    role: myRole,
                    checks: globalState[myRole].checks,
                    user: myName
                }
            };

            const res = await fetch(GAS_URL, {
                method: "POST",
                body: JSON.stringify(payload)
            });
            
            // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å…¨å“¡åˆ†ã®æœ€æ–°ãƒ‡ãƒ¼ã‚¿ãŒè¿”ã£ã¦ãã‚‹
            const serverState = await res.json();
            
            // ãƒ‡ãƒ¼ã‚¿ã‚’çµ±åˆ
            globalState = serverState;
            localStorage.setItem('ramen_state', JSON.stringify(globalState));
            
            // ç”»é¢ã‚’æ›´æ–°ï¼ˆä»–äººã®ãƒã‚§ãƒƒã‚¯ã‚’åæ˜ ï¼‰
            updateCheckboxes();

            // æ›´æ–°æ™‚åˆ»
            const now = new Date();
            document.getElementById('last-update').innerText = "æœ€çµ‚æ›´æ–°: " + now.getHours() + ":" + String(now.getMinutes()).padStart(2,'0');

        } catch(e) {
            console.error(e);
            alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ã€‚å±¥æ­´ã«æ®‹ã£ã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚");
        } finally {
            btn.innerText = "ğŸ”„ æ›´æ–°ï¼†å…±æœ‰ã™ã‚‹";
            btn.disabled = false;
        }
    }

    // ã‚µãƒ¼ãƒãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç”»é¢ã«åæ˜ ï¼ˆãƒ¬ç‚¹ã‚’ã¤ã‘ã‚‹ï¼‰
    function updateCheckboxes() {
        ['kitchen', 'hall', 'wash'].forEach(role => {
            document.getElementById(`user-${role}`).innerText = globalState[role].user || "-";
            ROLES[role].forEach((_, idx) => {
                const chk = document.getElementById(`chk-${role}-${idx}`);
                if(chk) {
                    chk.checked = !!globalState[role].checks[idx];
                }
            });
        });
    }

    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
    function switchTab(tabName) {
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        
        if(tabName === 'main') {
            document.querySelector('.nav-item:nth-child(1)').classList.add('active');
            document.getElementById('main-view').style.display = 'block';
            document.getElementById('history-view').style.display = 'none';
        } else {
            document.querySelector('.nav-item:nth-child(2)').classList.add('active');
            document.getElementById('main-view').style.display = 'none';
            document.getElementById('history-view').style.display = 'block';
            loadHistory();
        }
    }

    // å±¥æ­´èª­ã¿è¾¼ã¿
    async function loadHistory() {
        if(GAS_URL.includes("â˜…")) return;
        const list = document.getElementById('history-list');
        list.innerHTML = "èª­ã¿è¾¼ã¿ä¸­...";
        
        try {
            const res = await fetch(GAS_URL + "?action=history");
            const data = await res.json(); // [[æ—¥ä»˜, å½¹å‰², åå‰, çŠ¶æ³], ...]
            
            list.innerHTML = "";
            if(data.length === 0) list.innerHTML = "å±¥æ­´ãªã—";

            data.forEach(row => {
                // row: [æ—¥æ™‚, å½¹å‰², åå‰, çŠ¶æ³]
                let color = "#333";
                if(row[1]==="1ç•ªæ‰‹") color = "var(--c-kit)";
                if(row[1]==="ãƒ›ãƒ¼ãƒ«") color = "var(--c-hall)";
                if(row[1]==="æ´—ã„å ´") color = "var(--c-wash)";

                list.innerHTML += `
                    <div class="history-card" style="border-left-color:${color}">
                        <div style="font-weight:bold">${row[0]}</div>
                        <div>${row[1]} : ${row[2]}</div>
                        <div style="color:green; text-align:right">âœ… ${row[3]}</div>
                    </div>
                `;
            });
        } catch(e) {
            list.innerHTML = "èª­ã¿è¾¼ã¿å¤±æ•—";
        }
    }
</script>
</body>
</html>