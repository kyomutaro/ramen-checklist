<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ã¶ã£è±šãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ</title>
<style>
    /* å…¨ä½“ã®è‰²è¨­å®š */
    :root {
        --col-hall: #007bff;   /* ãƒ›ãƒ¼ãƒ«ï¼šé’ */
        --col-kitchen: #dc3545;/* 1ç•ªæ‰‹ï¼šèµ¤ */
        --col-wash: #28a745;   /* æ´—ã„å ´ï¼šç·‘ */
        --bg: #f8f9fa;
    }
    body { font-family: -apple-system, sans-serif; background: var(--bg); padding: 10px; padding-bottom: 80px; color: #333; }
    h1 { text-align: center; font-size: 1.2rem; margin: 10px 0; }

    /* ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ */
    #login-view { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 999; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; }
    .login-box { width: 100%; max-width: 400px; text-align: center; }
    input[type="text"] { width: 80%; padding: 12px; font-size: 1rem; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 20px; text-align: center; }
    .role-select-btn { width: 100%; padding: 15px; margin-bottom: 10px; border: none; border-radius: 8px; font-weight: bold; color: white; cursor: pointer; font-size: 1rem; }

    /* ãƒ¡ã‚¤ãƒ³ç”»é¢ï¼šãƒªã‚¹ãƒˆã®ã‚³ãƒ³ãƒ†ãƒŠ */
    .list-container { max-width: 600px; margin: 0 auto; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; }
    
    /* å„å½¹å‰²ã®ãƒ˜ãƒƒãƒ€ãƒ¼ */
    .role-header { padding: 10px 15px; font-weight: bold; color: white; display: flex; justify-content: space-between; align-items: center; }
    .worker-label { font-size: 0.8rem; background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 10px; font-weight: normal; }

    /* ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆé …ç›® */
    .check-group { padding: 5px 0; }
    .check-item { display: flex; align-items: center; padding: 10px 15px; border-bottom: 1px solid #eee; transition: 0.2s; }
    .check-item:last-child { border-bottom: none; }
    
    /* ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®è¦‹ãŸç›® */
    input[type="checkbox"] { transform: scale(1.5); margin-right: 15px; cursor: pointer; }

    /* â˜…ä»–äººã®å½¹å‰²ã®æ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆè–„ãã™ã‚‹ãƒ»æŠ¼ã›ãªã„ï¼‰ */
    .disabled-area { opacity: 0.6; background-color: #f9f9f9; }
    .disabled-area input[type="checkbox"] { cursor: not-allowed; }
    .disabled-area .check-item:hover { background: none; }

    /* è‡ªåˆ†ã®å½¹å‰²ã®æ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆå¼·èª¿ï¼‰ */
    .active-area { border: 2px solid; background-color: #fff; }
    .active-area.hall { border-color: var(--col-hall); }
    .active-area.kitchen { border-color: var(--col-kitchen); }
    .active-area.wash { border-color: var(--col-wash); }

    /* æ›´æ–°ãƒœã‚¿ãƒ³ï¼ˆãƒ•ãƒƒã‚¿ãƒ¼å›ºå®šï¼‰ */
    .footer-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-top: 1px solid #ddd; padding: 10px; display: flex; justify-content: center; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); }
    .sync-btn { width: 90%; max-width: 500px; padding: 12px; background: #333; color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 1.1rem; cursor: pointer; }
    .sync-btn:active { transform: scale(0.98); }

    /* æœ¬äººç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« */
    #confirm-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center; }
    .confirm-box { background: white; padding: 25px; border-radius: 10px; text-align: center; width: 80%; max-width: 300px; }
    .confirm-btns { display: flex; gap: 10px; margin-top: 20px; }
    .confirm-btns button { flex: 1; padding: 10px; border-radius: 5px; border: none; cursor: pointer; font-weight: bold; }

</style>
</head>
<body>

    <div id="login-view">
        <div class="login-box">
            <h2>ğŸ–ğŸœ æ¥­å‹™é–‹å§‹</h2>
            <p>åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
            <input type="text" id="input-name" placeholder="ä¾‹ï¼šæ‘ä¸Š">
            <p>ä»Šæ—¥ã®æ‹…å½“ã‚’é¸ã‚“ã§ãã ã•ã„</p>
            <button class="role-select-btn" style="background:var(--col-kitchen)" onclick="preLogin('kitchen')">ğŸ”¥ 1ç•ªæ‰‹ï¼ˆå¨æˆ¿ï¼‰</button>
            <button class="role-select-btn" style="background:var(--col-hall)" onclick="preLogin('hall')">ğŸ–ï¸ ãƒ›ãƒ¼ãƒ«</button>
            <button class="role-select-btn" style="background:var(--col-wash)" onclick="preLogin('wash')">ğŸ§¼ æ´—ã„å ´</button>
        </div>
    </div>

    <div id="confirm-modal">
        <div class="confirm-box">
            <p>ã‚ãªãŸã¯<br><b id="confirm-name" style="font-size:1.2rem"></b><br>ã•ã‚“ã§ã™ã‹ï¼Ÿ</p>
            <div class="confirm-btns">
                <button style="background:#ccc" onclick="closeConfirm()">ã„ã„ãˆ</button>
                <button style="background:#28a745; color:white" onclick="executeLogin()">ã¯ã„</button>
            </div>
        </div>
    </div>

    <div id="main-view" style="display:none;">
        <h1>é–‰åº—ãƒã‚§ãƒƒã‚¯ä¸€è¦§</h1>
        <p style="text-align:center; font-size:0.8rem; color:#666;" id="info-msg">æ›´æ–°ãƒœã‚¿ãƒ³ã§ã¿ã‚“ãªã®é€²æ—ã‚’ç¢ºèªã—ã‚ˆã†</p>

        <div id="area-kitchen" class="list-container disabled-area">
            <div class="role-header" style="background:var(--col-kitchen)">
                <span>ğŸ”¥ 1ç•ªæ‰‹</span>
                <span class="worker-label" id="user-kitchen">-</span>
            </div>
            <div class="check-group" id="list-kitchen"></div>
        </div>

        <div id="area-hall" class="list-container disabled-area">
            <div class="role-header" style="background:var(--col-hall)">
                <span>ğŸ–ï¸ ãƒ›ãƒ¼ãƒ«</span>
                <span class="worker-label" id="user-hall">-</span>
            </div>
            <div class="check-group" id="list-hall"></div>
        </div>

        <div id="area-wash" class="list-container disabled-area">
            <div class="role-header" style="background:var(--col-wash)">
                <span>ğŸ§¼ æ´—ã„å ´</span>
                <span class="worker-label" id="user-wash">-</span>
            </div>
            <div class="check-group" id="list-wash"></div>
        </div>
    </div>

    <div class="footer-bar" id="footer-bar" style="display:none;">
        <button class="sync-btn" onclick="syncData()">ğŸ”„ çŠ¶æ³ã‚’æ›´æ–°ãƒ»å…±æœ‰ã™ã‚‹</button>
    </div>

<script>
    // â˜…ã“ã“ã«æ–°ã—ã„GASã®URLã‚’å…¥ã‚Œã‚‹â˜…
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyfCcEPJpPOpLB9wHqJA4fAKxNqldV_QrM06Hi5gyytHzFDGhPdCD3-qpU74pCbTTTo/exec";

    // ãƒã‚§ãƒƒã‚¯é …ç›®å®šç¾©
    const ROLES = {
        kitchen: ["ã‚¬ã‚¹ã®å…ƒæ “é–‰ã‚ãŸ", "ã‚³ãƒ¼ãƒ«ãƒ‰ãƒ†ãƒ¼ãƒ–ãƒ«æ¸…æƒ", "ã‚¹ãƒ¼ãƒ—/è‚‰/é‡èœåç´", "è£œå……ç³»å®Œäº†", "æ°´é“é–‰ã‚ãŸ", "éººæ®‹é‡è¨˜å…¥"],
        hall: ["ç®¸é†¤æ²¹ãƒ»ãƒãƒ¨è£œå……", "ç”Ÿå§œé–‰ã¾ã£ãŸã‹", "åºŠã‚´ãƒŸç¢ºèª", "åˆ¸å£²æ©Ÿãƒ»éµé–‰ã‚", "èƒŒè„‚SWã‚ªãƒ•", "åµè£œå……", "ã‚´ãƒŸãƒ»ãƒˆã‚¤ãƒ¬é›»æ°—", "ã‚³ãƒƒãƒ—ã®ç‰‡ã¥ã‘", "ãƒ†ãƒ¼ãƒ–ãƒ«å…¨æ‹­ã"],
        wash: ["æ´—å‰¤ãƒ»ãƒãƒ³ãƒ‰ã‚½ãƒ¼ãƒ—è£œå……", "ã‚´ãƒŸæ¨ã¦å®Œäº†", "ã‚·ãƒ³ã‚¯å†…æ¸…æƒ", "æ´—ã„å ´ã‚´ãƒŸç¢ºèª"]
    };

    let myRole = "";
    let myName = "";
    let tempRole = ""; // æœ¬äººç¢ºèªç”¨

    // ä»Šã®å…¨ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ï¼ˆè‡ªåˆ†ï¼‹ä»–äººï¼‰
    let globalState = {
        kitchen: { checks: [], user: "" },
        hall: { checks: [], user: "" },
        wash: { checks: [], user: "" }
    };

    // ------------------------------------------
    // èµ·å‹•æ™‚ã®ãƒªã‚»ãƒƒãƒˆå‡¦ç†ï¼ˆç¿Œæœã‚¯ãƒªã‚¢ï¼‰
    // ------------------------------------------
    window.onload = function() {
        const today = new Date().toLocaleDateString('ja-JP');
        const savedDate = localStorage.getItem('ramen_date');

        // æ—¥ä»˜ãŒå¤‰ã‚ã£ã¦ã„ãŸã‚‰ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢
        if (savedDate !== today) {
            localStorage.removeItem('ramen_state');
            localStorage.setItem('ramen_date', today);
        } else {
            // åŒã˜æ—¥ãªã‚‰ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
            const savedState = localStorage.getItem('ramen_state');
            if (savedState) globalState = JSON.parse(savedState);
        }

        // åå‰ã®å¾©å…ƒ
        const savedName = localStorage.getItem('ramen_name');
        if (savedName) document.getElementById('input-name').value = savedName;
    };

    // ------------------------------------------
    // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
    // ------------------------------------------
    function preLogin(role) {
        const name = document.getElementById('input-name').value;
        if (!name) return alert("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        tempRole = role;
        document.getElementById('confirm-name').innerText = name;
        document.getElementById('confirm-modal').style.display = 'flex';
    }

    function closeConfirm() {
        document.getElementById('confirm-modal').style.display = 'none';
    }

    function executeLogin() {
        myRole = tempRole;
        myName = document.getElementById('input-name').value;
        localStorage.setItem('ramen_name', myName); // åå‰è¨˜æ†¶

        closeConfirm();
        document.getElementById('login-view').style.display = 'none';
        document.getElementById('main-view').style.display = 'block';
        document.getElementById('footer-bar').style.display = 'flex';

        // ç”»é¢æ§‹ç¯‰
        initChecklists();
        
        // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰æœ€æ–°çŠ¶æ…‹ã‚’å–å¾—ï¼ˆä»–äººã®é€²æ—ã‚’è¦‹ã‚‹ãŸã‚ï¼‰
        fetchState(); 
    }

    // ------------------------------------------
    // ãƒªã‚¹ãƒˆæç”»ï¼ˆåˆæœŸåŒ–ï¼‰
    // ------------------------------------------
    function initChecklists() {
        ['kitchen', 'hall', 'wash'].forEach(role => {
            const container = document.getElementById(`list-${role}`);
            const area = document.getElementById(`area-${role}`);
            container.innerHTML = "";

            // è‡ªåˆ†ã®å½¹å‰²ãªã‚‰ã€Œæ“ä½œå¯èƒ½ã‚¨ãƒªã‚¢ã€ã«ã™ã‚‹
            if (role === myRole) {
                area.classList.remove('disabled-area');
                area.classList.add('active-area', role);
            } else {
                area.classList.add('disabled-area');
                area.classList.remove('active-area');
            }

            // é …ç›®ç”Ÿæˆ
            ROLES[role].forEach((itemText, idx) => {
                const isChecked = globalState[role].checks[idx] ? "checked" : "";
                
                // ä»–äººã®å½¹å‰²ãªã‚‰ disabledï¼ˆæŠ¼ã›ãªã„ï¼‰ã«ã™ã‚‹
                const disabledAttr = (role === myRole) ? "" : "disabled";

                container.innerHTML += `
                    <label class="check-item">
                        <input type="checkbox" id="chk-${role}-${idx}" ${isChecked} ${disabledAttr} onchange="updateState('${role}', ${idx})">
                        <span>${itemText}</span>
                    </label>
                `;
            });
        });
    }

    // ------------------------------------------
    // çŠ¶æ…‹æ›´æ–°ï¼ˆãƒã‚§ãƒƒã‚¯ã—ãŸæ™‚ï¼‰
    // ------------------------------------------
    function updateState(role, idx) {
        if (role !== myRole) return; // å¿µã®ãŸã‚

        // ç”»é¢ã®ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã‚’ãƒ‡ãƒ¼ã‚¿ã«åæ˜ 
        const checkbox = document.getElementById(`chk-${role}-${idx}`);
        
        // é…åˆ—ãŒãªã‘ã‚Œã°åˆæœŸåŒ–
        if (!globalState[role].checks) globalState[role].checks = [];
        globalState[role].checks[idx] = checkbox.checked;
        globalState[role].user = myName;

        // ã‚¹ãƒãƒ›ã«ä¿å­˜
        saveLocal();
    }

    // ------------------------------------------
    // ã‚µãƒ¼ãƒãƒ¼åŒæœŸï¼ˆæ›´æ–°ãƒœã‚¿ãƒ³ï¼‰
    // ------------------------------------------
    async function syncData() {
        const btn = document.querySelector('.sync-btn');
        btn.innerText = "é€šä¿¡ä¸­...";
        btn.disabled = true;

        try {
            // 1. è‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã‚’é€ã‚‹
            const payload = {
                action: "update",
                data: {
                    role: myRole,
                    checks: globalState[myRole].checks,
                    user: myName
                }
            };

            const res = await fetch(GAS_URL, {
                method: "POST",
                body: JSON.stringify(payload)
            });

            // 2. å…¨å“¡ã®æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å—ã‘å–ã‚‹
            const serverState = await res.json();
            
            // 3. ãƒ‡ãƒ¼ã‚¿çµ±åˆï¼ˆè‡ªåˆ†ã®æ“ä½œä¸­ãƒ‡ãƒ¼ã‚¿ãŒæ¶ˆãˆãªã„ã‚ˆã†ã«ã€ä»–äººã®ãƒ‡ãƒ¼ã‚¿ã ã‘ä¸Šæ›¸ãæ¨å¥¨ã ãŒã€ä»Šå›ã¯åŒæœŸé‡è¦–ã§ã‚µãƒ¼ãƒãƒ¼å„ªå…ˆï¼‰
            globalState = serverState;
            saveLocal();

            // 4. ç”»é¢å†æç”»ï¼ˆä»–äººã®ãƒã‚§ãƒƒã‚¯åæ˜ ï¼‰
            refreshView();

            alert("æ›´æ–°ã—ã¾ã—ãŸï¼");

        } catch(e) {
            console.error(e);
            alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ã€‚é›»æ³¢ã‚’ç¢ºèªã—ã¦ãã ã•ã„");
        } finally {
            btn.innerText = "ğŸ”„ çŠ¶æ³ã‚’æ›´æ–°ãƒ»å…±æœ‰ã™ã‚‹";
            btn.disabled = false;
        }
    }

    // èª­ã¿è¾¼ã¿å°‚ç”¨ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ç›´å¾Œãªã©ï¼‰
    async function fetchState() {
        if(GAS_URL.includes("â˜…")) return;
        try {
            const res = await fetch(GAS_URL);
            const serverState = await res.json();
            
            // ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®ãƒã‚§ãƒƒã‚¯
            if(serverState.hall) {
                globalState = serverState;
                saveLocal();
                refreshView();
            }
        } catch(e) { console.error(e); }
    }

    // ç”»é¢ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ãƒ‡ãƒ¼ã‚¿ã«åˆã‚ã›ã¦æ›¸ãæ›ãˆã‚‹
    function refreshView() {
        ['kitchen', 'hall', 'wash'].forEach(role => {
            // æ‹…å½“è€…åæ›´æ–°
            document.getElementById(`user-${role}`).innerText = globalState[role].user || "-";

            ROLES[role].forEach((_, idx) => {
                const checkbox = document.getElementById(`chk-${role}-${idx}`);
                if (checkbox) {
                    // ãƒ‡ãƒ¼ã‚¿ã«åˆã‚ã›ã¦ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã‚‹/å¤–ã™
                    checkbox.checked = !!globalState[role].checks[idx];
                }
            });
        });
    }

    function saveLocal() {
        localStorage.setItem('ramen_state', JSON.stringify(globalState));
    }
</script>
</body>
</html>