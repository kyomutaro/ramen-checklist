<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="robots" content="noindex,nofollow">
<title>ãƒ©ãƒ¼ãƒ¡ãƒ³åº— é–‰åº—æ¥­å‹™ç®¡ç†</title>
<style>
    :root {
        --color-hall: #007bff; /* é’ */
        --color-kitchen: #dc3545; /* èµ¤ */
        --color-wash: #28a745; /* ç·‘ */
        --bg-gray: #f8f9fa;
    }
    body { font-family: -apple-system, sans-serif; margin: 0; padding: 0; background: var(--bg-gray); padding-bottom: 70px; /* ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒãƒ¼åˆ† */ }
    
    /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
    .header { background: white; padding: 15px; text-align: center; border-bottom: 1px solid #ddd; position: sticky; top: 0; z-index: 100; }
    .header h1 { margin: 0; font-size: 1.2rem; color: #333; }
    .last-update { font-size: 0.8rem; color: #666; margin-top: 5px; }

    /* åˆå›ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ */
    #login-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 999; display: flex; justify-content: center; align-items: center; }
    .login-box { background: white; padding: 25px; border-radius: 10px; width: 85%; max-width: 400px; text-align: center; }
    .role-btn { display: block; width: 100%; padding: 15px; margin: 10px 0; border: none; border-radius: 8px; font-weight: bold; color: white; cursor: pointer; font-size: 1rem; }
    
    /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
    .container { padding: 15px; max-width: 600px; margin: 0 auto; }
    
    /* å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .section { background: white; border-radius: 10px; padding: 15px; margin-bottom: 20px; border-top: 5px solid #ccc; opacity: 0.6; pointer-events: none; /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ç„¡åŠ¹ */ transition: 0.3s; }
    
    /* è‡ªåˆ†ã®æ‹…å½“ã‚¨ãƒªã‚¢ã ã‘æœ‰åŠ¹åŒ– */
    .section.active { opacity: 1; pointer-events: auto; box-shadow: 0 4px 12px rgba(0,0,0,0.1); transform: scale(1.02); }
    
    /* å½¹å‰²ã”ã¨ã®è‰² */
    .section.hall { border-color: var(--color-hall); }
    .section.kitchen { border-color: var(--color-kitchen); }
    .section.wash { border-color: var(--color-wash); }
    
    .section h2 { margin-top: 0; font-size: 1.1rem; border-bottom: 1px dashed #eee; padding-bottom: 10px; display: flex; justify-content: space-between; }
    .worker-display { font-size: 0.8rem; font-weight: normal; color: #666; background: #eee; padding: 2px 8px; border-radius: 10px; }

    /* ãƒã‚§ãƒƒã‚¯é …ç›® */
    .check-item { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid #f0f0f0; }
    .check-item input { transform: scale(1.5); margin-right: 15px; cursor: pointer; }
    
    /* åŒæœŸãƒœã‚¿ãƒ³ */
    .sync-btn { width: 100%; padding: 15px; background: #333; color: white; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: bold; cursor: pointer; margin-top: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
    .sync-btn:active { transform: translateY(2px); }

    /* ä¸‹éƒ¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒãƒ¼ */
    .bottom-menu { position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-top: 1px solid #ddd; display: flex; justify-content: space-around; padding: 10px 0; z-index: 200; }
    .menu-item { text-align: center; flex: 1; cursor: pointer; color: #999; }
    .menu-item.active { color: #e44d26; font-weight: bold; }
    .menu-icon { font-size: 1.5rem; display: block; margin-bottom: 2px; }

    /* å±¥æ­´ç”»é¢ */
    #history-view { display: none; padding: 15px; }
    .history-card { background: white; padding: 15px; margin-bottom: 10px; border-radius: 8px; font-size: 0.9rem; border-left: 4px solid #333; }

    /* å…¨å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
    #complete-msg { display: none; text-align: center; padding: 20px; background: #d4edda; color: #155724; border-radius: 10px; margin-bottom: 20px; font-weight: bold; border: 2px solid #c3e6cb; }
</style>
</head>
<body>

    <div id="login-modal">
        <div class="login-box">
            <h2>ğŸœ æ¥­å‹™é–‹å§‹</h2>
            <p>åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
            <input type="text" id="username-input" style="width:100%; padding:10px; margin-bottom:15px; box-sizing:border-box;" placeholder="ä¾‹ï¼šæ‘ä¸Š">
            <p>ä»Šæ—¥ã®æ‹…å½“ã‚’é¸ã‚“ã§ãã ã•ã„</p>
            <button class="role-btn" style="background:var(--color-hall)" onclick="login('hall')">ğŸ–ï¸ ãƒ›ãƒ¼ãƒ«</button>
            <button class="role-btn" style="background:var(--color-wash)" onclick="login('wash')">ğŸ§¼ æ´—ã„å ´</button>
            <button class="role-btn" style="background:var(--color-kitchen)" onclick="login('kitchen')">ğŸ”¥ 1ç•ªæ‰‹</button>
        </div>
    </div>

    <div class="header">
        <h1>é–‰åº—ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ</h1>
        <div class="last-update" id="last-update-time">æœªåŒæœŸ</div>
    </div>

    <div id="checklist-view" class="container">
        <div id="complete-msg">ğŸ‰ æœ¬æ—¥ã®æ¥­å‹™ã¯ã™ã¹ã¦å®Œäº†ã—ã¾ã—ãŸï¼å±¥æ­´ã«ä¿å­˜ã•ã‚Œã¾ã—ãŸã€‚</div>

        <div class="section hall" id="sec-hall">
            <h2>ğŸ–ï¸ ãƒ›ãƒ¼ãƒ« <span class="worker-display" id="user-hall">æœªç€æ‰‹</span></h2>
            <div id="list-hall"></div>
        </div>

        <div class="section wash" id="sec-wash">
            <h2>ğŸ§¼ æ´—ã„å ´ <span class="worker-display" id="user-wash">æœªç€æ‰‹</span></h2>
            <div id="list-wash"></div>
        </div>

        <div class="section kitchen" id="sec-kitchen">
            <h2>ğŸ”¥ 1ç•ªæ‰‹ <span class="worker-display" id="user-kitchen">æœªç€æ‰‹</span></h2>
            <div id="list-kitchen"></div>
        </div>

        <button class="sync-btn" onclick="syncData()">ğŸ”„ çŠ¶æ³ã‚’æ›´æ–°ãƒ»å…±æœ‰ã™ã‚‹</button>
        <p style="text-align:center; font-size:0.8rem; color:#666;">â€»ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ä»–äººã®çŠ¶æ³ã‚‚åæ˜ ã•ã‚Œã¾ã™</p>
    </div>

    <div id="history-view" class="container">
        <h2>ğŸ“‹ éå»ã®å®Œäº†å±¥æ­´</h2>
        <button onclick="fetchHistory()" style="padding:10px; width:100%; margin-bottom:15px;">å±¥æ­´ã‚’å†èª­ã¿è¾¼ã¿</button>
        <div id="history-list">èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>

    <div class="bottom-menu">
        <div class="menu-item active" onclick="switchTab('check')">
            <span class="menu-icon">ğŸ“</span>ãƒã‚§ãƒƒã‚¯
        </div>
        <div class="menu-item" onclick="switchTab('history')">
            <span class="menu-icon">ğŸ“…</span>å±¥æ­´
        </div>
    </div>

<script>
    // 
    const GAS_URL = "https://script.google.com/macros/s/AKfycbzyuU5t4gRep64dgtoblRLO3ZbsILq7BguPf14SQmpzMivssjL3gAVNfEO3ghx98y_5/exec";

    // å®šæ•°ãƒ»ãƒ‡ãƒ¼ã‚¿å®šç¾©
    const ROLES = {
        hall: ["ç®¸é†¤æ²¹ã€ãƒãƒ¨è£œå……", "ç”Ÿå§œé–‰ã¾ã£ãŸã‹", "åºŠã‚´ãƒŸç¢ºèª", "åˆ¸å£²æ©Ÿãƒ»éµé–‰ã‚", "èƒŒè„‚SWã‚ªãƒ•", "åµè£œå……", "ã‚´ãƒŸãƒ»ãƒˆã‚¤ãƒ¬é›»æ°—", "ãƒ†ãƒ¼ãƒ–ãƒ«å…¨æ‹­ã"],
        wash: ["æ´—å‰¤è£œå……", "ã‚´ãƒŸæ¨ã¦å®Œäº†"],
        kitchen: ["ã‚¬ã‚¹å…ƒæ “é–‰", "ã‚³ãƒ¼ãƒ«ãƒ‰ãƒ†ãƒ¼ãƒ–ãƒ«", "ã‚¹ãƒ¼ãƒ—è‚‰é‡èœåç´", "è£œå……ç³»å®Œäº†", "æ°´é“é–‰", "éººæ®‹é‡è¨˜å…¥"]
    };

    let myRole = "";
    let myName = "";
    
    // ç¾åœ¨ã®ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ï¼ˆåˆæœŸå€¤ï¼‰
    let globalState = {
        hall: { checks: Array(8).fill(false), user: "" },
        wash: { checks: Array(2).fill(false), user: "" },
        kitchen: { checks: Array(6).fill(false), user: "" }
    };

    // --------------------------------------------------
    // 1. åˆæœŸåŒ–ãƒ»ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
    // --------------------------------------------------
    window.onload = function() {
        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰å¾©å…ƒï¼ˆèª¤ã£ã¦é–‰ã˜ãŸã¨ãå¯¾ç­–ï¼‰
        const savedName = localStorage.getItem('ramen_name');
        const savedRole = localStorage.getItem('ramen_role');
        const savedState = localStorage.getItem('ramen_temp_state');

        if(savedName) document.getElementById('username-input').value = savedName;

        // çŠ¶æ…‹ã®å¾©å…ƒ
        if(savedState) {
            globalState = JSON.parse(savedState);
            renderCheckboxes(); // ç”»é¢æå†™
        }
        
        // ã™ã§ã«ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ãªã‚‰ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’æ¶ˆã™
        if (savedName && savedRole) {
            login(savedRole, true); // true = ç”»é¢å†ãƒ­ãƒ¼ãƒ‰æ™‚ã®è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³
        }
    };

    function login(role, isAuto = false) {
        const nameInput = document.getElementById('username-input');
        if (!nameInput.value) return alert("åå‰ã‚’å…¥ã‚Œã¦ãã ã•ã„");
        
        myRole = role;
        myName = nameInput.value;
        
        // ä¿å­˜
        localStorage.setItem('ramen_name', myName);
        localStorage.setItem('ramen_role', myRole);

        // UIåˆ‡ã‚Šæ›¿ãˆ
        document.getElementById('login-modal').style.display = 'none';
        
        // è‡ªåˆ†ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã ã‘è§¦ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹
        document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
        document.getElementById(`sec-${role}`).classList.add('active');

        if (!isAuto) {
            // åˆå›ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã¯ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰æœ€æ–°çŠ¶æ…‹ã‚’å–å¾—ã—ã«è¡Œã
            syncData();
        }
        renderCheckboxes();
    }

    // --------------------------------------------------
    // 2. ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®æå†™æ©Ÿèƒ½
    // --------------------------------------------------
    function renderCheckboxes() {
        ['hall', 'wash', 'kitchen'].forEach(role => {
            const container = document.getElementById(`list-${role}`);
            container.innerHTML = "";
            
            // æ‹…å½“è€…åã®è¡¨ç¤ºæ›´æ–°
            const userSpan = document.getElementById(`user-${role}`);
            userSpan.innerText = globalState[role].user || "æœªç€æ‰‹";

            ROLES[role].forEach((itemText, idx) => {
                const isChecked = globalState[role].checks[idx];
                const div = document.createElement('div');
                div.className = 'check-item';
                div.innerHTML = `
                    <label style="width:100%; display:flex; align-items:center; cursor:pointer;">
                        <input type="checkbox" 
                            ${isChecked ? "checked" : ""} 
                            onchange="updateLocalState('${role}', ${idx}, this.checked)"
                            ${role !== myRole ? "disabled" : ""} >
                        <span style="${isChecked ? 'color:#bbb; text-decoration:line-through' : ''}">${itemText}</span>
                    </label>
                `;
                container.appendChild(div);
            });
        });
    }

    // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’æŠ¼ã—ãŸæ™‚ã®å‡¦ç†ï¼ˆã¾ãšã¯ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ï¼‰
    function updateLocalState(role, idx, checked) {
        if (role !== myRole) return; // å¿µã®ãŸã‚ã‚¬ãƒ¼ãƒ‰
        
        globalState[role].checks[idx] = checked;
        globalState[role].user = myName; // ä½œæ¥­è€…åã‚’æ›´æ–°
        
        // ã‚¹ãƒãƒ›å†…ã«ä¸€æ™‚ä¿å­˜ï¼ˆé–‰ã˜ã¦ã‚‚å¤§ä¸ˆå¤«ãªã‚ˆã†ã«ï¼‰
        localStorage.setItem('ramen_temp_state', JSON.stringify(globalState));
        
        renderCheckboxes(); // è¦‹ãŸç›®æ›´æ–°
    }

    // --------------------------------------------------
    // 3. ã‚µãƒ¼ãƒãƒ¼åŒæœŸï¼ˆAæ¡ˆï¼šãƒœã‚¿ãƒ³æ›´æ–°ï¼‰
    // --------------------------------------------------
    async function syncData() {
        const btn = document.querySelector('.sync-btn');
        btn.innerText = "é€šä¿¡ä¸­...";
        btn.disabled = true;

        try {
            // é€ä¿¡ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ï¼ˆè‡ªåˆ†ã®å½¹å‰²éƒ¨åˆ†ã ã‘ã‚’é€ã‚‹ï¼‰
            const payload = {
                action: "sync",
                data: {
                    role: myRole,
                    checks: globalState[myRole].checks,
                    user: myName
                }
            };

            const res = await fetch(GAS_URL, {
                method: "POST",
                body: JSON.stringify(payload)
            });
            
            const serverState = await res.json();
            
            // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã§ä¸Šæ›¸ãæ›´æ–°
            globalState = serverState;
            localStorage.setItem('ramen_temp_state', JSON.stringify(globalState)); // ãƒ­ãƒ¼ã‚«ãƒ«ã‚‚æ›´æ–°
            
            renderCheckboxes();
            
            // å…¨å“¡å®Œäº†åˆ¤å®š
            if(serverState.isArchived) {
                document.getElementById('complete-msg').style.display = 'block';
            }

            // æ™‚åˆ»æ›´æ–°
            const now = new Date();
            document.getElementById('last-update-time').innerText = "æœ€çµ‚åŒæœŸ: " + now.getHours() + ":" + String(now.getMinutes()).padStart(2,'0');

        } catch(e) {
            alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ã€‚é›»æ³¢ã®è‰¯ã„ã¨ã“ã‚ã§å†åº¦æŠ¼ã—ã¦ãã ã•ã„ã€‚");
            console.error(e);
        } finally {
            btn.innerText = "ğŸ”„ çŠ¶æ³ã‚’æ›´æ–°ãƒ»å…±æœ‰ã™ã‚‹";
            btn.disabled = false;
        }
    }

    // --------------------------------------------------
    // 4. ãƒ¡ãƒ‹ãƒ¥ãƒ¼åˆ‡ã‚Šæ›¿ãˆãƒ»å±¥æ­´
    // --------------------------------------------------
    function switchTab(tabName) {
        // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®è¦‹ãŸç›®
        document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
        event.currentTarget.classList.add('active');

        if (tabName === 'check') {
            document.getElementById('checklist-view').style.display = 'block';
            document.getElementById('history-view').style.display = 'none';
        } else {
            document.getElementById('checklist-view').style.display = 'none';
            document.getElementById('history-view').style.display = 'block';
            fetchHistory();
        }
    }

    async function fetchHistory() {
        const list = document.getElementById('history-list');
        list.innerHTML = "èª­ã¿è¾¼ã¿ä¸­...";
        
        try {
            const res = await fetch(GAS_URL + "?action=history");
            const data = await res.json();
            
            list.innerHTML = "";
            if (data.length === 0) list.innerHTML = "ã¾ã å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“";

            data.forEach(row => {
                // row: [æ—¥ä»˜, ãƒ›ãƒ¼ãƒ«å, ã‚­ãƒƒãƒãƒ³å, æ´—ã„å ´å, å®Œäº†]
                const date = new Date(row[0]).toLocaleString();
                list.innerHTML += `
                    <div class="history-card">
                        <div style="font-weight:bold; margin-bottom:5px;">${date}</div>
                        <div>ğŸ–ï¸ ${row[1]} / ğŸ”¥ ${row[2]} / ğŸ§¼ ${row[3]}</div>
                        <div style="color:green; font-size:0.8rem; margin-top:5px;">${row[4]}</div>
                    </div>
                `;
            });
        } catch(e) {
            list.innerHTML = "èª­ã¿è¾¼ã¿å¤±æ•—";
        }
    }
</script>
</body>
</html>