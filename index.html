<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ã¶ã£è±šãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆğŸ–</title>
<style>
    /* ã¶ã£è±šã‚«ãƒ©ãƒ¼ */
    :root {
        --c-hall: #007bff;
        --c-kit: #d63384;
        --c-wash: #198754;
        --bg: #f8f9fa;
    }
    body { font-family: "Hiragino Kaku Gothic ProN", sans-serif; margin: 0; padding: 0; background: var(--bg); padding-bottom: 120px; }
    
    header { background: white; padding: 15px; text-align: center; border-bottom: 3px solid #333; position: sticky; top: 0; z-index: 10; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    h1 { margin: 0; font-size: 1.4rem; font-weight: 900; color: #333; letter-spacing: 1px; }

    /* ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ */
    #login-view { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 100; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    .login-inner { width: 85%; max-width: 400px; text-align: center; }
    input[type="text"] { width: 100%; padding: 15px; font-size: 1.1rem; margin-bottom: 20px; box-sizing: border-box; text-align: center; border: 2px solid #333; border-radius: 8px; font-weight: bold; }
    .role-btn { width: 100%; padding: 15px; margin-bottom: 15px; border: none; border-radius: 50px; color: white; font-weight: bold; cursor: pointer; font-size: 1.1rem; box-shadow: 0 4px 0 rgba(0,0,0,0.2); transition: 0.1s; }
    .role-btn:active { transform: translateY(4px); box-shadow: none; }

    /* æœ¬äººç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« */
    #confirm-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 200; justify-content: center; align-items: center; }
    .confirm-box { background: white; padding: 30px; border-radius: 15px; width: 80%; max-width: 300px; text-align: center; border: 2px solid #333; }
    .confirm-btns { display: flex; gap: 10px; margin-top: 20px; }
    .confirm-btns button { flex: 1; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem; }

    /* â˜…å…¨å“¡å®Œäº†æ™‚ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ç”»é¢ */
    #all-complete-view { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 300; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; backdrop-filter: blur(5px); }
    .complete-msg { font-size: 1.5rem; font-weight: bold; margin-bottom: 30px; line-height: 1.5; color: #333; }
    .final-btn { width: 100%; max-width: 300px; padding: 20px; background: #e44d26; color: white; border: none; border-radius: 10px; font-size: 1.2rem; font-weight: bold; cursor: pointer; box-shadow: 0 5px 15px rgba(228, 77, 38, 0.4); animation: pulse 2s infinite; }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

    /* ãƒ¡ã‚¤ãƒ³ç”»é¢ãƒªã‚¹ãƒˆ */
    .list-section { background: white; margin: 15px; border-radius: 12px; overflow: hidden; box-shadow: 0 3px 6px rgba(0,0,0,0.05); border: 1px solid #ddd; }
    .role-header { padding: 12px 15px; color: white; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
    .worker-name { font-size: 0.8rem; background: rgba(255,255,255,0.9); color: #333; padding: 2px 10px; border-radius: 20px; font-weight: bold; }
    
    .check-item { padding: 15px; border-bottom: 1px solid #eee; display: flex; align-items: center; font-size: 1.05rem; }
    input[type="checkbox"] { transform: scale(1.6); margin-right: 15px; cursor: pointer; }

    .disabled-area { opacity: 0.5; background: #eee; pointer-events: none; filter: grayscale(80%); }
    .active-area { border: 2px solid #333; background: #fff; transform: scale(1.01); }

    /* ãƒ•ãƒƒã‚¿ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒãƒ¼ï¼ˆæ›´æ–°ãƒœã‚¿ãƒ³ã®ã¿ï¼‰ */
    .action-bar { position: fixed; bottom: 60px; left: 0; width: 100%; background: rgba(255,255,255,0.95); padding: 10px 15px; display: flex; flex-direction: column; gap: 10px; box-sizing: border-box; border-top: 1px solid #ddd; backdrop-filter: blur(5px); }
    .sync-btn { width: 100%; padding: 14px; background: #444; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem; }

    /* å±¥æ­´ç”»é¢ */
    #history-view { display: none; padding: 15px; }
    .history-card { background: white; padding: 12px; border-radius: 8px; margin-bottom: 10px; border-left: 6px solid #ccc; font-size: 0.95rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

    /* ä¸‹éƒ¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
    .nav-bar { position: fixed; bottom: 0; left: 0; width: 100%; height: 60px; background: white; border-top: 1px solid #ddd; display: flex; z-index: 50; }
    .nav-item { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #aaa; font-size: 0.7rem; cursor: pointer; }
    .nav-item.active { color: #333; font-weight: 900; background: #f0f0f0; }
    .nav-icon { font-size: 1.6rem; margin-bottom: 2px; }

</style>
</head>
<body>

    <header>
        <h1>ğŸ– ã¶ã£è±šãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ</h1>
    </header>

    <div id="login-view">
        <div class="login-inner">
            <h2 style="margin-bottom:20px;">ä»Šæ—¥ã‚‚ä¸€æ—¥<br>ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼</h2>
            <p>åå‰ã‚’å…¥åŠ›</p>
            <input type="text" id="input-name" placeholder="ä¾‹ï¼šæ‘ä¸Š">
            <p>æ‹…å½“ã‚’é¸æŠ</p>
            <button class="role-btn" style="background:var(--c-kit)" onclick="preLogin('kitchen')">ğŸ”¥ 1ç•ªæ‰‹ï¼ˆå¨æˆ¿ï¼‰</button>
            <button class="role-btn" style="background:var(--c-hall)" onclick="preLogin('hall')">ğŸ–ï¸ ãƒ›ãƒ¼ãƒ«</button>
            <button class="role-btn" style="background:var(--c-wash)" onclick="preLogin('wash')">ğŸ§¼ æ´—ã„å ´</button>
        </div>
    </div>

    <div id="confirm-modal">
        <div class="confirm-box">
            <p>ã‚ãªãŸã¯<br><b id="confirm-name" style="font-size:1.4rem; color:#e44d26;"></b><br>ã•ã‚“ã§ã™ã‹ï¼Ÿ</p>
            <div class="confirm-btns">
                <button style="background:#ccc; color:#333;" onclick="closeConfirm()">ã„ã„ãˆ</button>
                <button style="background:#e44d26; color:white" onclick="executeLogin()">ã¯ã„</button>
            </div>
        </div>
    </div>

    <div id="all-complete-view">
        <div class="complete-msg">
            ğŸ– å…¨é …ç›®ãƒã‚§ãƒƒã‚¯å®Œäº†ï¼ğŸ–<br><br>
            ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼<br>
            é€€å‹¤å ±å‘Šã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚
        </div>
        <button class="final-btn" onclick="finishAll()">âœ… å±¥æ­´ã«ä¿å­˜ã—ã¦ã‚¯ãƒªã‚¢</button>
        <button onclick="closeCompleteView()" style="margin-top:20px; background:none; border:none; color:#666; text-decoration:underline; cursor:pointer;">â€»ã¾ã ä¿®æ­£ç®‡æ‰€ãŒã‚ã‚‹</button>
    </div>

    <div id="main-view">
        <div id="area-kitchen" class="list-section">
            <div class="role-header" style="background:var(--c-kit)">
                <span>ğŸ”¥ 1ç•ªæ‰‹</span> <span class="worker-name" id="user-kitchen">-</span>
            </div>
            <div id="list-kitchen"></div>
        </div>

        <div id="area-hall" class="list-section">
            <div class="role-header" style="background:var(--c-hall)">
                <span>ğŸ–ï¸ ãƒ›ãƒ¼ãƒ«</span> <span class="worker-name" id="user-hall">-</span>
            </div>
            <div id="list-hall"></div>
        </div>

        <div id="area-wash" class="list-section">
            <div class="role-header" style="background:var(--c-wash)">
                <span>ğŸ§¼ æ´—ã„å ´</span> <span class="worker-name" id="user-wash">-</span>
            </div>
            <div id="list-wash"></div>
        </div>

        <div class="action-bar">
            <button class="sync-btn" onclick="syncData()">ğŸ”„ æ›´æ–°ï¼ˆé€²æ—å…±æœ‰ï¼‰</button>
        </div>
    </div>

    <div id="history-view">
        <h3 style="text-align:center; margin-top:0;">å®Œäº†å±¥æ­´</h3>
        <button onclick="loadHistory()" style="width:100%; padding:10px; margin-bottom:15px; border-radius:5px; border:1px solid #ccc; background:white;">å†èª­ã¿è¾¼ã¿</button>
        <div id="history-list">èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>

    <div class="nav-bar">
        <div class="nav-item active" onclick="switchTab('main')">
            <span class="nav-icon">ğŸ“</span>ãƒã‚§ãƒƒã‚¯
        </div>
        <div class="nav-item" onclick="switchTab('history')">
            <span class="nav-icon">ğŸ“…</span>å±¥æ­´
        </div>
    </div>

<script>
    // â˜…æ–°ã—ã„GASã®URLã‚’å…¥ã‚Œã‚‹â˜…
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyS4bqet3JbKS2H3Oh2-_tmmEfiQA-OWiNVeH-2kYjfgrOUZ-Ce6lysRGTaxegMk0iX/exec";

    const ROLES = {
        kitchen: ["ã‚¬ã‚¹ã®å…ƒæ “é–‰", "ã‚³ãƒ¼ãƒ«ãƒ‰ãƒ†ãƒ¼ãƒ–ãƒ«", "ã‚¹ãƒ¼ãƒ—ãƒ»è‚‰ãƒ»é‡èœåç´", "è£œå……ç³»å®Œäº†", "æ°´é“é–‰", "éººæ®‹é‡è¨˜å…¥"],
        hall: ["ç®¸é†¤æ²¹ã€ãƒãƒ¨è£œå……", "ç”Ÿå§œé–‰ã¾ã£ãŸã‹", "åºŠã‚´ãƒŸç¢ºèª", "åˆ¸å£²æ©Ÿãƒ»éµé–‰ã‚", "èƒŒè„‚SWã‚ªãƒ•", "åµè£œå……", "ã‚´ãƒŸãƒ»ãƒˆã‚¤ãƒ¬é›»æ°—", "ãƒ†ãƒ¼ãƒ–ãƒ«å…¨æ‹­ã", "ã‚³ãƒƒãƒ—ã®ç‰‡ã¥ã‘"],
        wash: ["æ´—å‰¤ãƒ»ãƒãƒ³ãƒ‰ã‚½ãƒ¼ãƒ—è£œå……", "ã‚´ãƒŸæ¨ã¦å®Œäº†", "ã‚·ãƒ³ã‚¯å†…æ¸…æƒ", "æ´—ã„å ´ã‚´ãƒŸç¢ºèª"]
    };

    let myRole = "";
    let myName = "";
    let tempRole = ""; 
    
    let globalState = {
        kitchen: { checks: [], user: "" },
        hall: { checks: [], user: "" },
        wash: { checks: [], user: "" }
    };

    window.onload = function() {
        const savedName = localStorage.getItem('ramen_name');
        if(savedName) document.getElementById('input-name').value = savedName;
    };

    // --- ãƒ­ã‚°ã‚¤ãƒ³é–¢é€£ ---
    function preLogin(role) {
        const name = document.getElementById('input-name').value;
        if(!name) return alert("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        tempRole = role;
        document.getElementById('confirm-name').innerText = name;
        document.getElementById('confirm-modal').style.display = 'flex';
    }

    function closeConfirm() {
        document.getElementById('confirm-modal').style.display = 'none';
    }

    function executeLogin() {
        myRole = tempRole;
        myName = document.getElementById('input-name').value;
        localStorage.setItem('ramen_name', myName);

        closeConfirm();
        document.getElementById('login-view').style.display = 'none';
        
        initView();
        syncData();
    }

    // --- ç”»é¢æ§‹ç¯‰ ---
    function initView() {
        ['kitchen', 'hall', 'wash'].forEach(role => {
            const container = document.getElementById(`list-${role}`);
            const area = document.getElementById(`area-${role}`);
            container.innerHTML = "";
            
            if(role === myRole) {
                area.classList.remove('disabled-area');
                area.classList.add('active-area');
            } else {
                area.classList.add('disabled-area');
                area.classList.remove('active-area');
            }

            ROLES[role].forEach((text, idx) => {
                container.innerHTML += `
                    <div class="check-item">
                        <input type="checkbox" id="chk-${role}-${idx}" onchange="localCheck('${role}', ${idx})">
                        <span>${text}</span>
                    </div>
                `;
            });
        });
    }

    // --- ãƒ­ãƒ¼ã‚«ãƒ«ãƒã‚§ãƒƒã‚¯å‡¦ç† ---
    function localCheck(role, idx) {
        const chk = document.getElementById(`chk-${role}-${idx}`);
        if(!globalState[role].checks) globalState[role].checks = [];
        globalState[role].checks[idx] = chk.checked;
        globalState[role].user = myName;
        
        // æ¯å›ã€Œå…¨å“¡å®Œäº†ã—ãŸã‹ï¼Ÿã€ã‚’ãƒã‚§ãƒƒã‚¯
        checkAllComplete();
    }

    // --- å…¨å“¡å®Œäº†åˆ¤å®š ---
    function checkAllComplete() {
        let isAllDone = true;
        
        ['kitchen', 'hall', 'wash'].forEach(role => {
            const checks = globalState[role].checks;
            const total = ROLES[role].length;
            
            // ãƒã‚§ãƒƒã‚¯æ•°ãŒè¶³ã‚Šãªã„ã€ã¾ãŸã¯falseãŒã‚ã‚‹å ´åˆ
            if (!checks || checks.length < total) isAllDone = false;
            else {
                for(let i=0; i<total; i++) {
                    if(!checks[i]) isAllDone = false;
                }
            }
        });

        // å…¨å“¡å®Œäº†ãªã‚‰ç”»é¢ã‚’å‡ºã™ï¼
        if (isAllDone) {
            document.getElementById('all-complete-view').style.display = 'flex';
        } else {
            document.getElementById('all-complete-view').style.display = 'none';
        }
    }

    function closeCompleteView() {
        document.getElementById('all-complete-view').style.display = 'none';
    }

    // --- æ›´æ–°ï¼ˆå…±æœ‰ï¼‰ãƒœã‚¿ãƒ³ ---
    async function syncData() {
        const btn = document.querySelector('.sync-btn');
        btn.innerText = "é€šä¿¡ä¸­...";
        btn.disabled = true;

        try {
            const payload = {
                action: "update",
                data: {
                    role: myRole,
                    checks: globalState[myRole].checks,
                    user: myName
                }
            };
            const res = await fetch(GAS_URL, { method: "POST", body: JSON.stringify(payload) });
            const serverState = await res.json();
            
            globalState = serverState;
            reflectToView();
            checkAllComplete(); // æ›´æ–°æ™‚ã‚‚å®Œäº†åˆ¤å®šã™ã‚‹
            
        } catch(e) {
            console.error(e);
        } finally {
            btn.innerText = "ğŸ”„ æ›´æ–°ï¼ˆé€²æ—å…±æœ‰ï¼‰";
            btn.disabled = false;
        }
    }

    // --- ä¸€æ‹¬å®Œäº†ãƒ»ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ï¼ˆã‚¢ãƒ³ã‚«ãƒ¼ãŒæŠ¼ã™ï¼‰ ---
    async function finishAll() {
        if(!confirm("å…¨å“¡åˆ†ã‚’å±¥æ­´ã«ä¿å­˜ã—ã¦ã€ãƒã‚§ãƒƒã‚¯ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã€‚\nã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;

        const btn = document.querySelector('.final-btn');
        btn.innerText = "å‡¦ç†ä¸­...";
        btn.disabled = true;

        try {
            const payload = {
                action: "finish_all",
                data: {} // ç‰¹ã«ãªã—
            };
            const res = await fetch(GAS_URL, { method: "POST", body: JSON.stringify(payload) });
            const serverState = await res.json();
            
            globalState = serverState;
            reflectToView();
            closeCompleteView();
            alert("å…¨ä¿å­˜å®Œäº†ï¼\nãŠç–²ã‚Œæ§˜ã§ã—ãŸğŸ–");
            
            switchTab('history');

        } catch(e) {
            alert("é€ä¿¡ã‚¨ãƒ©ãƒ¼");
        } finally {
            btn.innerText = "âœ… å±¥æ­´ã«ä¿å­˜ã—ã¦ã‚¯ãƒªã‚¢";
            btn.disabled = false;
        }
    }

    function reflectToView() {
        ['kitchen', 'hall', 'wash'].forEach(role => {
            document.getElementById(`user-${role}`).innerText = globalState[role].user || "-";
            ROLES[role].forEach((_, idx) => {
                const chk = document.getElementById(`chk-${role}-${idx}`);
                if(chk) chk.checked = !!globalState[role].checks[idx];
            });
        });
    }

    // --- ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ ---
    function switchTab(tabName) {
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        if(tabName === 'main') {
            document.querySelector('.nav-item:nth-child(1)').classList.add('active');
            document.getElementById('main-view').style.display = 'block';
            document.getElementById('history-view').style.display = 'none';
            document.querySelector('.action-bar').style.display = 'flex';
        } else {
            document.querySelector('.nav-item:nth-child(2)').classList.add('active');
            document.getElementById('main-view').style.display = 'none';
            document.getElementById('history-view').style.display = 'block';
            document.querySelector('.action-bar').style.display = 'none';
            loadHistory();
        }
    }

    async function loadHistory() {
        if(GAS_URL.includes("â˜…")) return;
        const list = document.getElementById('history-list');
        list.innerHTML = "èª­ã¿è¾¼ã¿ä¸­...";
        try {
            const res = await fetch(GAS_URL + "?action=history");
            const data = await res.json();
            list.innerHTML = "";
            if(data.length === 0) list.innerHTML = "å±¥æ­´ãªã—";
            data.forEach(row => {
                let color = "#333";
                if(row[1]==="1ç•ªæ‰‹") color = "var(--c-kit)";
                if(row[1]==="ãƒ›ãƒ¼ãƒ«") color = "var(--c-hall)";
                if(row[1]==="æ´—ã„å ´") color = "var(--c-wash)";
                list.innerHTML += `
                    <div class="history-card" style="border-left-color:${color}">
                        <b>${row[0]}</b> ${row[1]} : ${row[2]} <span style="float:right;color:green">æ¸ˆ</span>
                    </div>`;
            });
        } catch(e) { list.innerHTML = "èª­ã¿è¾¼ã¿å¤±æ•—"; }
    }
</script>
</body>
</html>